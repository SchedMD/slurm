#!/usr/bin/env expect
############################################################################
# Purpose: Test for proper handling of different rank end times
############################################################################
# Copyright (C) SchedMD LLC.
#
# This file is part of Slurm, a resource management program.
# For details, see <https://slurm.schedmd.com/>.
# Please also read the included file: DISCLAIMER.
#
# Slurm is free software; you can redistribute it and/or modify it under
# the terms of the GNU General Public License as published by the Free
# Software Foundation; either version 2 of the License, or (at your option)
# any later version.
#
# Slurm is distributed in the hope that it will be useful, but WITHOUT ANY
# WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
# FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more
# details.
#
# You should have received a copy of the GNU General Public License along
# with Slurm; if not, write to the Free Software Foundation, Inc.,
# 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301  USA.
############################################################################
source ./globals

set file_in	"$test_dir/input"
set het_job_id  0

proc cleanup {} {
	global het_job_id

	cancel_job $het_job_id 1
}

if {[get_config_param "SchedulerType"] ne "sched/backfill"} {
	skip "This test requires SchedulerType = sched/backfill"
}

set nb_nodes [get_partition_param [default_partition] "TotalNodes"]
if {$nb_nodes < 3} {
	skip "Need 3 or more nodes in default partition"
}

# HetJobs are scheduled only by backfill, therefore we better submit a single
# het job and run multiple steps on it to make the test faster
set het_job_id [submit_job -fail "-t1 -N1 : -N1 : -N1 --wrap 'sleep infinity'"]
if {[wait_for_step ${het_job_id}.batch] != $::RETURN_SUCCESS} {
	fail "Batch step for job $het_job_id not found"
}

# All steps will run into all components of the hetjob
set srun_cmd "$srun --jobid $het_job_id --label --mpi=none --het-group=0-2 $file_in"
set re_component "($number): SLURMD_NODENAME"

# Submit step forcing ascendent order (the first component is the first to end)
make_bash_script $file_in "
#!/usr/bin/env bash
sleep_time=`expr \$SLURM_PROCID`
sleep \$sleep_time
env | grep SLURMD_NODENAME
"
set output [run_command -fail "$srun_cmd"]
set matches [regexp -all $re_component $output]
subtest {$matches == 3} "All 3components should work properly when finishing in ascendent order" ",but got only $matches"

# Submit step forcing descendent order (the first component is the last to end)
make_bash_script $file_in "
#!/usr/bin/env bash
sleep_time=`expr 3 - \$SLURM_PROCID`
sleep \$sleep_time
env | grep SLURMD_NODENAME
"
set output [run_command -fail "$srun_cmd"]
set matches [regexp -all $re_component $output]
subtest {$matches == 3} "All 3components should work properly when finishing in descendent order" ",but got only $matches"
